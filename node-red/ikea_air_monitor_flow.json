[
    {
        "id": "a1b2c3d4e5f6g7h8",
        "type": "tab",
        "label": "IKEA Air Monitor",
        "disabled": false,
        "info": ""
    },
    {
        "id": "http_in_node",
        "type": "http in",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "",
        "url": "/sensor",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 80,
        "wires": [
            [
                "parse_and_threshold"
            ]
        ]
    },
    {
        "id": "parse_and_threshold",
        "type": "function",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "format + thresholds",
        "func": "\nconst data = msg.payload;\nconst timestamp = Date.now(); // Milliseconds for InfluxDB v2\nconst location = \"Schlafzimmer\";\nconst device_id = \".152\";\nconst device_type = \"AirQualityMonitor\";\n\nfunction getNumericValue(value, defaultValue = 0) {\n    return (value !== null && value !== undefined && !isNaN(value)) ? Number(value) : defaultValue;\n}\n\nfunction getBoolAsInt(value) {\n    return value ? 1 : 0;\n}\n\nconst thresholds = {\n    aqi_index: 100,\n    co2_equivalent_ppm: 1000,\n    pm2_5_ugm3: 35,\n    tvoc_mgm3: 1.0,\n    humidity_low: 30,\n    humidity_high: 70\n};\n\nconst influxObject = {\n    measurement: \"air_quality\",\n    tags: {\n        device_id: device_id,\n        location: location,\n        device_type: device_type,\n        data_type: \"environmental\"\n    },\n    fields: {\n        temperature_celsius: getNumericValue(data.environment.main_temperature),\n        humidity_percent: getNumericValue(data.environment.humidity),\n        pressure_hpa: getNumericValue(data.environment.pressure),\n        ds_temperature_celsius: getNumericValue(data.environment.ds_temperature),\n        dew_point_celsius: data.comfort ? getNumericValue(data.comfort.dew_point) : 0,\n        heat_index_celsius: data.comfort ? getNumericValue(data.comfort.heat_index) : 0,\n        absolute_humidity_gm3: data.comfort ? getNumericValue(data.comfort.absolute_humidity) : 0,\n        comfort_index: data.comfort ? getNumericValue(data.comfort.comfort_assessment.score * 100) : 0,\n        aqi_index: data.calculated_aqi ? getNumericValue(data.calculated_aqi.combined) : 0,\n        aqi_category: data.calculated_aqi ? getNumericValue(data.calculated_aqi.combined <= 50 ? 1 : data.calculated_aqi.combined <= 100 ? 2 : data.calculated_aqi.combined <= 150 ? 3 : data.calculated_aqi.combined <= 200 ? 4 : 5) : 0,\n        pm2_5_aqi: data.calculated_aqi ? getNumericValue(data.calculated_aqi.pm2_5_aqi) : 0,\n        pm10_aqi: data.calculated_aqi ? getNumericValue(data.calculated_aqi.pm10_aqi) : 0,\n        iaq_aqi: data.calculated_aqi ? getNumericValue(data.calculated_aqi.iaq_aqi) : 0,\n        iaq_index: getNumericValue(data.air_quality.iaq),\n        static_iaq: getNumericValue(data.air_quality.static_iaq),\n        iaq_accuracy_level: getNumericValue(data.air_quality.iaq_accuracy),\n        gas_resistance_ohm: getNumericValue(data.air_quality.gas_resistance),\n        co2_equivalent_ppm: getNumericValue(data.air_quality.co2_equivalent),\n        co2_bme_equivalent_ppm: getNumericValue(data.air_quality.co2_equivalent),\n        co2_accuracy_level: getNumericValue(data.air_quality.co2_accuracy),\n        tvoc_ppb: getNumericValue(data.air_quality.breath_voc * 1000),\n        tvoc_mgm3: getNumericValue(data.air_quality.breath_voc),\n        voc_accuracy_level: getNumericValue(data.air_quality.voc_accuracy),\n        pm1_0_ugm3: getNumericValue(data.air_quality.pm1_0),\n        pm2_5_ugm3: getNumericValue(data.air_quality.pm2_5),\n        pm10_ugm3: getNumericValue(data.air_quality.pm10),\n        sensor_reliable: getBoolAsInt(data.system.checksum_valid),\n        bme68x_stable: getBoolAsInt(data.air_quality.iaq_accuracy >= 2),\n        bme68x_runin_complete: getBoolAsInt(data.air_quality.iaq_accuracy >= 3),\n        sensors_available_count: getBoolAsInt(data.system.sensors_available.bme680) + getBoolAsInt(data.system.sensors_available.ds18b20) + getBoolAsInt(data.system.sensors_available.pms5003),\n        wifi_rssi_dbm: getNumericValue(data.system.wifi_rssi),\n        uptime_seconds: getNumericValue(data.system.uptime_seconds),\n        timestamp: timestamp\n    }\n};\n\nconst alerts = {\n    alert_aqi: influxObject.fields.aqi_index > thresholds.aqi_index,\n    alert_co2: influxObject.fields.co2_equivalent_ppm > thresholds.co2_equivalent_ppm,\n    alert_pm25: influxObject.fields.pm2_5_ugm3 > thresholds.pm2_5_ugm3,\n    alert_tvoc: influxObject.fields.tvoc_mgm3 > thresholds.tvoc_mgm3,\n    alert_humidity_low: influxObject.fields.humidity_percent < thresholds.humidity_low,\n    alert_humidity_high: influxObject.fields.humidity_percent > thresholds.humidity_high\n};\n\nif (!Object.values(alerts).some(Boolean)) {\n    return null; // nothing exceeded threshold\n}\n\nObject.assign(influxObject.fields, Object.fromEntries(Object.entries(alerts).map(([k, v]) => [k, getBoolAsInt(v)])));\n\nmsg.payload = [influxObject];\nmsg.influx_data = data; // Keep original data for other nodes\n\nnode.log(`Generated InfluxDB v2 object with ${Object.keys(influxObject.fields).length} fields`);\nnode.log(`AQI: ${influxObject.fields.aqi_index}, IAQ: ${influxObject.fields.iaq_index}, CO2: ${influxObject.fields.co2_equivalent_ppm}`);\n\nreturn msg;\n",

        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 80,
        "wires": [
            [
                "influxdb_out",
                "http_response"
            ]
        ]
    },
    {
        "id": "influxdb_out",
        "type": "influxdb out",
        "z": "a1b2c3d4e5f6g7h8",
        "influxdb": "influxdb_config",
        "name": "",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "x": 610,
        "y": 60,
        "wires": []
    },
    {
        "id": "http_response",
        "type": "http response",
        "z": "a1b2c3d4e5f6g7h8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 610,
        "y": 120,
        "wires": []
    },
    {
        "id": "influxdb_config",
        "type": "influxdb",
        "hostname": "influxdb",
        "port": "8086",
        "protocol": "http",
        "database": "airquality",
        "name": "InfluxDB",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "2.0",
        "url": "http://influxdb:8086",
        "rejectUnauthorized": false,
        "credentials": {
            "username": "",
            "password": ""
        },
        "v2url": "http://influxdb:8086",
        "v2org": "",
        "v2bucket": "airquality",
        "v2token": "",
        "influxdbClientOptions": "{}",
        "httpProxy": ""
    }

]

